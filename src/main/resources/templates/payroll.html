<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" th:href="@{/img/filename.jpg}" />
  <link rel="icon" type="image/png" th:href="@{/img/filename.jpg}" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>HRMS</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
  <meta name="viewport" content="width=device-width" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.15.0/css/all.css}">
  <script rel="stylesheet"  th:src="@{/webjars/font-awesome/5.15.0/js/all.js}"></script>
  <link th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap-material-design/0.5.10/css/bootstrap-material-design.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap-select/1.12.4/css/bootstrap-select.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap-clockpicker.css}">
  <link th:href="@{/webjars/datatables/1.10.12/css/jquery.dataTables.css}" rel="stylesheet">
  <link th:href="@{/css/material-dashboard.css}" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/material-design-icons/4.0.0/material-icons.css}">
  <link th:href="@{/css/payslip.css}" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/print.min.css}">
  <style>
  	.datepicker,
	.table-condensed {
	  width: 320px;
	  height:250px;
	}
	.alert-minimalist, alert-maximalist, alert-errormalist {
	background-color: #3880ff;
	border-color: rgba(149, 149, 149, 0.3);
	border-radius: 3px;
	color: #ffffff;
	padding: 15px;
}
.alert-minimalist >[data-notify="dismiss"], .alert-maximalise >[data-notify="dismiss"], .alert-errormalise > [data-notify="dismiss"]{
	top: 50%;
    left: 50%;
}
.alert-minimalist > [data-notify="icon"], .alert-maximalise > [data-notify="icon"], .alert-errormalise > [data-notify="icon"]{
	font-size:30px;
	color:#ffffff;
	margin-top:25%;
}
.alert-minimalist > [data-notify="title"], .alert-maximalise > [data-notify="title"], .alert-errormalise > [data-notify="title"]{
	color: #ffffff;
	display: block;
	font-weight: bold;
	margin-bottom: 5px;
}
.alert-minimalist > [data-notify="message"], .alert-maximalise > [data-notify="message"], .alert-errormalise > [data-notify="message"] {
	font-size: 80%;
}
.alert-maximalise {
	background-color: #69bb7b;
	color:#ffffff;
}
.alert-errormalise{
    background-color: #f04141;
    color:#ffffff;
}
</style>
  </head>
<body >
<div class="wrapper" id="wrapper" style="display: none">

  <div class="sidebar" data-active-color="primary" data-background-color="black" data-image="/img/sidebar-3.jpg">
    <div class="logo">
      <a  class="simple-text logo-mini">

      </a>

      <a href="#" class="simple-text logo-normal">
        HRMS
      </a>
    </div>

    <div class="sidebar-wrapper">
      <div class="user">
        <div class="photo">
          <img th:src="@{${'/docs-upload/' +user.employee.image.name}}" />
        </div>
        <div class="info">
          <a data-toggle="collapse" href="#collapseExample" class="collapsed">
                    <span th:text="${user.username}">
                        <b class="caret"></b>
                    </span>
          </a>
          <div class="clearfix"></div>
          <div class="collapse" id="collapseExample">
            <ul class="nav">
              <li>
                <a data-toggle="modal" data-target="#lock-modal">
                  <span class="sidebar-mini"> CP </span>
                  <span class="sidebar-normal"> Change Password </span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <ul class="nav">
        <li >
          <a th:href="@{/admin/dashboard}">
            <i class="material-icons">dashboard</i>
            <p> Dashboard </p>
          </a>
        </li>
        <li>
          <a th:href="@{/admin/employee}">
            <i class="material-icons">people_alt</i>
            <p> Employees </p>
          </a>
        </li>
        <li >
          <a th:href="@{/admin/structure}" >
            <i class="material-icons">view_quilt</i>
            <p> Structure </p>
          </a>
        </li>
        <li >
          <a th:href="@{/admin/leave}" >
            <i class="material-icons">weekend</i>
            <p>Leave </p>
          </a>
        </li>
        <li>
          <a data-toggle="collapse" href="#pagesAttendance">
            <i class="material-icons">history_toggle_off</i>
            <p> Attendance
              <b class="caret"></b>
            </p>
          </a>

          <div class="collapse" id="pagesAttendance">
            <ul class="nav">
              <li>
                <a th:href="@{/admin/attendance/log}">
                  <span class="sidebar-mini">AL</span>
                  <span class="sidebar-normal">Attandance Log</span>
                </a>
              </li>
              <li>
                <a th:href="@{/admin/attendance/schedule}">
                  <span class="sidebar-mini">SC</span>
                  <span class="sidebar-normal">Schedule</span>
                </a>
              </li>
            </ul>
          </div>
        </li>
        <li sec:authorize="hasRole('ROLE_HR')">
          <a data-toggle="collapse" href="#pagesExamples">
            <i class="material-icons sidebar-mini">account_balance_wallet</i>
            <p> Payment
              <b class="caret"></b>
            </p>
          </a>

          <div class="collapse" id="pagesExamples">
            <ul class="nav">
              <li class="active">
                <a th:href="@{/hr/payroll}">
                  <span class="sidebar-mini"> PR </span>
                  <span class="sidebar-normal"> Payroll </span>
                </a>
              </li>
              <li>
                <a th:href="@{/hr/template}">
                  <span class="sidebar-mini"> PM </span>
                  <span class="sidebar-normal"> Pay Model </span>
                </a>
              </li>
            </ul>
          </div>
        </li>
        <li sec:authorize="hasRole('ROLE_HR')">
          <a th:href="@{/hr/general}">
            <i class="material-icons">tune</i>
            <p> General </p>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <div class="main-panel">

    <nav class="navbar navbar-transparent navbar-absolute">
      <div class="container-fluid">
        <div class="navbar-minimize">
          <button id="minimizeSidebar" class="btn btn-round btn-white btn-fill btn-just-icon">
            <i class="material-icons visible-on-sidebar-regular">more_vert</i>
            <i class="material-icons visible-on-sidebar-mini">view_list</i>
          </button>
        </div>
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" id="page-heading">Payroll </a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right" id="nav-btns-list">
            <li id="payroll-nav" class="nav-active">
              <a th:href="@{/hr/payroll}">
                <i class="material-icons">dashboard</i>
                Payroll
              </a>
            </li>
            <li id="preview-nav">
              <a >
                <i class="material-icons">preview</i>
                Preview
              </a>
            </li>
            <li class="dropdown">
              <a  class="dropdown-toggle" data-toggle="dropdown" data-color="success" >
                <i class="material-icons">notifications</i>
                <span class="notification" id="unreceived-size">0</span>
                <p class="hidden-lg hidden-md">
                  Notifications
                  <b class="caret"></b>
                </p>
              </a>
              <ul class="dropdown-menu panel-group"  id="unreceived-view"  role="tablist" aria-multiselectable="true">
                <li th:each="reminder:${unreceivedReminders}">
                  <a th:attr="onclick=${'viewUnReceived('+reminder.id+',this)'}">
                    &nbsp;<span th:text="${reminder.day +' '+ reminder.date+' '+reminder.time}"></span>
                  </a>
                </li>
              </ul>
            </li>
            <li>
              <a th:href="@{/logout}" class="dropdown-toggle"  data-color="success">
                <span class="material-icons"> logout</span>
                <p class="hidden-lg hidden-md">Logout</p>
              </a>
            </li>
            <li class="separator hidden-lg hidden-md"></li>
          </ul>
          <form class="navbar-form navbar-right" id="search-form" role="search">
            <div class="form-group form-search is-empty">
              <input type="text" class="form-control" placeholder="Search" id="payroll-search-bar">
              <span class="material-input"></span>
            </div>
            <button type="submit" class="btn btn-white btn-round btn-just-icon">
              <i class="material-icons">search</i><div class="ripple-container"></div>
            </button>
          </form>
        </div>
      </div>
    </nav>

    <div class="content" id="content-wrapper">
      <div class="container-fluid" id="content">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header card-header-icon" data-background-color="primary">
                <i class="material-icons">assignment</i>
              </div>
              <div class="card-content">
                <h4 class="card-title">Employees On Payroll</h4>
                <div class="toolbar">
                  <button  class="btn btn-primary" style="color:#fff;float:right;" data-toggle="modal" data-target="#calculate-payroll-modal">
                    <i class="material-icons">receipt_long</i>&nbsp;&nbsp;calculate
                  </button>
                  <button class="btn btn-primary" id="goToMaonth" style="color:#fff" data-toggle="modal" data-target="#past-payroll-modal">
                    <i class="material-icons">today</i>&nbsp;&nbsp;Past Payroll
                  </button>
                </div>
                <div class="material-datatables">
                  <table id="employees-table" class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
                    <thead>
	                    <tr>
	                      <th>PayRoll No.</th>
	                      <th>Name</th>
	                      <th>KRA</th>
	                      <th>Salary</th>
	                      <th>Bank</th>
                          <th>Account No</th>
                          <th></th>
	                    </tr>
                    </thead>
                    <tfoot>
	                    <tr>
	                      <th>PayRoll No.</th>
	                      <th>Name</th>
	                      <th>KRA</th>
	                      <th>Salary</th>
	                      <th>Bank</th>
                          <th>Account No</th>
                          <th></th>
	                    </tr>
                    </tfoot>
                  </table>
                </div>
              </div><!-- end content-->
            </div><!--  end card  -->
          </div> <!-- end col-md-12 -->
        </div> <!-- end row -->
      </div>
    </div>
  </div>
</div>
<div class="loader-wrapper">
  <div class="dot-container">
    <div class="dot dot1"></div>
    <div class="dot dot2"></div>
    <div class="dot dot3"></div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="print-payroll-modal">
  <div class="modal-dialog " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title primary-text fw-4" >Print Payroll</h4>
      </div>
      <div class="modal-body">
        <form id="print-form">
          <div class="input-group date datepicker-group period-date" data-provide="datepicker" >
          <label class="bmd-label-floating">period</label>
          <input type="text" class="form-control datetimepicker" id ="print-period-date"  required>
          <div class="input-group-addon">
            <i class="far fa-calendar-alt"></i>
          </div>
        </div>
          <div class="checkbox">
            <label>
              <input type="checkbox" name="optionsCheckboxes" id="payroll-checkbox">
              payroll
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input type="checkbox" name="optionsCheckboxes" id ="payslip-checkbox">
              payslips
            </label>
          </div>
          <div class="form-group">
            <input type="submit" class="btn btn-primary" value="proceed" style="color:#ffffff">
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="calculate-payroll-modal">
  <div class="modal-dialog " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title primary-text fw-4" >Calculate Payroll</h4>
      </div>
      <div class="modal-body">

          <div class="input-group date datepicker-group period-date" data-provide="datepicker" >
            <label class="bmd-label-floating">period</label>
            <input type="text" class="form-control datetimepicker" id ="calculate-period-date">
            <div class="input-group-addon">
              <i class="far fa-calendar-alt"></i>
            </div>
          </div>
          <div class="form-group">
            <button onclick="calculate()" class="btn btn-primary" style="color:#ffffff">proceed</button>
          </div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="past-payroll-modal">
  <div class="modal-dialog " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title primary-text fw-4" >Past Payroll</h4>
      </div>
      <div class="modal-body">

        <div class="input-group date datepicker-group period-date" data-provide="datepicker" >
          <label class="bmd-label-floating">period</label>
          <input type="text" class="form-control datetimepicker" id ="past-period-date">
          <div class="input-group-addon">
            <i class="far fa-calendar-alt"></i>
          </div>
        </div>
        <div class="form-group">
          <button onclick="past()" class="btn btn-primary" style="color:#ffffff">proceed</button>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="generate-payroll-modal">
  <div class="modal-dialog " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title primary-text fw-4" >Print Payroll</h4>
      </div>
      <div class="modal-body">

          <div class="input-group">
            <label class="bmd-label-floating">period</label>
             <h3 id ="generate-period"></h3>
          </div>
          <div class="checkbox">
            <label>
              <input type="checkbox" name="optionsCheckboxes" id="generate-payroll-checkbox">
              payroll
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input type="checkbox" name="optionsCheckboxes" id ="generate-payslip-checkbox">
              payslips
            </label>
          </div>
          <div class="form-group">
            <input type="submit" onclick="generate()" class="btn btn-primary" value="proceed" style="color:#ffffff">
          </div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="myModal" data-keyboard="false" data-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="display:flex;justify-content:space-between">
        <h4 class="modal-title">Edit  Payslip</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
      </div><div class="container"></div>
      <div class="modal-body">
          <div class="payhead-toolbar">
            <div>
              <button class="btn btn-default btn-round" style="color:#ffffff" id="add-earning-deduction" data-toggle="modal" data-target="#add-payhead-modal">Add PayHead</button>
            </div>
            <div class="btn-group-container">
              <div style="color:#fff" class="btn-wrapper">
                <button id="save-template-btn" onclick="savePayslip()" class="btn btn-success btn-fab btn-fab-mini btn-round"><i class="material-icons">save</i></button><br><label>SAVE</label>
              </div>
              <div class="btn-wrapper">
                <button id="clear-template-btn" class="btn btn-danger btn-fab btn-fab-mini btn-round"><i class="material-icons">clear</i></button><br><label>CLEAR</label>
              </div>
            </div>
          </div>
          <div class="payhead-wrapper">
            <div class="earnings-payhead">
              <ul class="payhead-list" id="earnings-list">

              </ul>
              <div class="total-container">
                <h6 style="margin-right:70px">Total</h6>
                <label id="earnings-total" style="margin-top:12px">0</label>
              </div>
            </div>
            <div class="deductions-payhead">
              <ul class="payhead-list" id="deductions-list">

              </ul>
              <div class="total-container" style="flex-direction: row-reverse;justify-content: end;">
                <h6 style="margin-left:70px">Total</h6>
                <label id="deductions-total" style="margin-top:12px">0</label>
              </div>
            </div>
          </div>

          <div class="nssf-nhif-relief-container">
            <hr>
            <div class="nssf-nhif-relief-wrapper">
              <div class="nhr-container">
                <div class="nhr1">NSSF</div>
                <div class="nhr2" id="template-nssf">0</div>
                <div class="nhr3">
                  <button data-toggle="modal" data-target="#add-nssf-modal" class="btn btn-success btn-fab btn-fab-mini btn-round"><i class="material-icons">edit</i></button>
                </div>
              </div>
              <div class="nhr-container">
                <div class="nhr1">NHIF</div>
                <div class="nhr2" id="template-nhif">0</div>
                <div class="nhr3">
                  <button data-toggle="modal" data-target="#add-nhif-modal" class="btn btn-success btn-fab btn-fab-mini btn-round"><i class="material-icons">edit</i></button>
                </div>
              </div>
            </div>
          </div>

      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="edit-payhead-modal">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title primary-text fw-4" >Edit &nbsp; Payhead</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="bmd-label-floating">Payhead Name</label>
            <input type="text" class="form-control" id='edit-payhead-name' autocomplete ='off' required>
          </div>
          <div class="form-group">
            <label class="bmd-label-floating">Payhead Amount</label>
            <input type="text" class="form-control" id='edit-payhead-amount'  autocomplete ='off' required>
          </div>
          <div class="form-group">
            <input id="edit-payhead-btn" class="btn btn-primary" value="submit" style="color:#ffffff">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade "  tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel"id="add-payhead-modal" data-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">Add Payhead</div>
        <div class="modal-body">
          <form id="payhead-form">
            <div class="form-group">
              <label class="bmd-label-floating">Name</label>
              <input type="text" class="form-control"  name='name' id="payhead-name" autocomplete ='off' required>
            </div>
            <div class="form-group">
              <label class="bmd-label-floating">Amount</label>
              <input type="number" class="form-control" name='amount' id="payhead-amount" autocomplete ='off' required>
            </div>
            <div class="form-group">
              <select class="selectpicker" data-style="btn btn-white btn-round" title="Single Select" id="payhead-type" name="payhead-type" required>
                <option disabled selected>Select Type</option>
                <option value="deduction">Deduction</option>
                <option value="earning">Earning</option>
              </select>
            </div>
            <div class="form-group" style="display:flex;justify-content:space-between">
              <button type="submit" class="btn pull-right btn-primary" style="color:#ffffff">Submit</button>
              <button onClick="closeAddPayhead()" class="btn pull-right btn-danger" style="color:#ffffff">calcel</button>
            </div>
          </form>
        </div>
        <div class="modal-footer"></div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="add-nssf-modal">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title primary-text fw-4" >Add NSSF</h4>
        </div>
        <div class="modal-body">
          <form  id="nssf-form">
            <div class="form-group">
              <label class="bmd-label-floating" for="nssf-input" >Nssf</label>
              <input type="text" class="form-control" id="nssf-input" autocomplete ='off' required>
            </div>
            <div class="form-group">
              <input  type="submit" class="btn btn-primary" value="submit" style="color:#ffffff">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="add-nhif-modal">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title primary-text fw-4" >Add NHIF</h4>
        </div>
        <div class="modal-body">
          <form  id="nhif-form">
            <div class="form-group">
              <label class="bmd-label-floating" for="nhif-input">nhif</label>
              <input type="number" class="form-control" id="nhif-input"  autocomplete ='off' required>
            </div>
            <div class="form-group">
              <input  type="submit" class="btn btn-primary" value="submit" style="color:#ffffff">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="lock-modal">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-body" >
        <div style="display:flex;justify-content: center;margin-top:-70px">
          <a href="#pablo">
            <img class="avatar" style="height:100px;width: 80px" th:src="@{${'/docs-upload/' +user.employee.image.name}}" alt="...">
          </a>
        </div>
        <form id="lock-form">
          <div class="row">
            <div class="col-md-12" style="display: flex;justify-content:center;">
              <h4 class="card-title" th:text="${user.username}"></h4>
            </div>
            <div class="col-md-12">
              <div class="form-group label-floating">
                <label class="control-label">Current Password</label>
                <input type="text" id="current-password" class="form-control secure" autocomplete="off" required>
              </div>
              <div class="form-group label-floating">
                <label class="control-label">New Password <small> (minimum 4 characters)</small></label>
                <input type="text" id="new-password" class="form-control secure" autocomplete="off" required>
              </div>
              <div class="form-group label-floating">
                <label class="control-label">Confirm New Password</label>
                <input type="text" id="confirm-password" class="form-control secure" autocomplete="off" required>
              </div>
            </div>
            <div class="col-md-12" style="display: flex;justify-content: center">
              <button  id="submit-password" class="btn btn-primary btn-round" style="color:#ffffff">Submit</button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

</body>

<!--   Core JS Files   -->
<script th:src="@{/webjars/jquery/3.3.1/jquery.js}"></script>
<script th:src="@{/webjars/bootstrap-material-design/0.5.10/js/material.js}"></script>
<script th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.js}"></script>
<script th:src="@{/js/perfect-scrollbar.jquery.min.js}" type="text/javascript"></script>

<!-- Library for adding dinamically elements -->
<script th:src="@{/js/arrive.min.js}" type="text/javascript"></script>

<!-- Forms Validations Plugin -->
<script th:src="@{/js/jquery.validate.min.js}"></script>

<!--  Plugin for Date Time Picker and Full Calendar Plugin-->
<script th:src="@{/webjars/momentjs/2.24.0/moment.js}"></script>

<!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
<script th:src="@{/js/jquery.bootstrap-wizard.js}"></script>

<!--  Notifications Plugin, full documentation here: https://bootstrap-notify.remabledesigns.com/    -->
<script th:src="@{/webjars/bootstrap-notify/3.1.3-1/bootstrap-notify.js}"></script>

<!--   Sharrre Library    -->
<script th:src="@{/js/jquery.sharrre.js}"></script>

<!-- Vector Map plugin, full documentation here: https://jvectormap.com/documentation/ -->
<script th:src="@{/js/jquery-jvectormap.js}"></script>

<!-- Sliders Plugin, full documentation here: https://refreshless.com/nouislider/ -->
<script th:src="@{/js/nouislider.min.js}"></script>

<!--  Plugin for Select, full documentation here: https://silviomoreto.github.io/bootstrap-select -->
<script th:src="@{/webjars/bootstrap-select/1.12.4/js/bootstrap-select.js}"></script>

<!--  DataTables.net Plugin, full documentation here: https://datatables.net/    -->
<script th:src="@{/webjars/datatables/1.10.12/js/jquery.dataTables.js}"></script>

<!-- Sweet Alert 2 plugin, full documentation here: https://limonte.github.io/sweetalert2/ -->
<script th:src="@{/js/sweetalert2.js}"></script>

<!-- Plugin for Fileupload, full documentation here: https://www.jasny.net/bootstrap/javascript/#fileinput -->
<script th:src="@{/js/jasny-bootstrap.min.js}"></script>

<!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
<script th:src="@{/js/fullcalendar.min.js}"></script>

<!-- Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
<script th:src="@{/js/jquery.tagsinput.js}"></script>

<script th:src="@{/webjars/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js}"></script>

<!-- Material Dashboard javascript methods -->
<script th:src="@{/js/material-dashboard.js}"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
<script th:src="@{/webjars/sockjs-client/1.1.2/sockjs.min.js}"></script>
<script th:src="@{/webjars/stomp-websocket/2.3.3-1/stomp.min.js}"></script>
<script th:inline="javascript">
  var employees = [[${employees}]];
  var unreceivedReminders = [[${unreceivedReminders}]];
</script>
<script>
  $(document).ready(function() {
    $('#employees-table').DataTable({
      "sDom": 'lrtip',
      "lengthMenu": [ [-1, 500, 200,100, 50], ["All", 500, 200, 100, 50] ],
      "columnDefs": [
        { className: "td-actions text-right", "targets": [ 6 ] }
      ]
    });
    var employeeTable = $('#employees-table').DataTable();
    $('#payroll-search-bar').keyup(function(){
      employeeTable.search($(this).val()).draw() ;
    });
    for(let i= 0;i<employees.length;i++){
      employeeTable.row.add([
        employees[i].payrollNumber,
        employees[i].name,
        employees[i].kra,
        employees[i].salary,
        employees[i].bankName,
        employees[i].accountPin,
        '<button rel="tooltip" class="btn btn-success btn-round"  onclick= "editEmployee('+ employees[i].id +')" ><i class="material-icons">edit</i></button>&nbsp;<button rel="tooltip" class="btn btn-danger btn-round"  onclick= "removeFromPayroll(this,'+ employees[i].id +')" ><i class="material-icons" >delete_forever</i></button>'
      ]).draw();
    }
  });
  let payroll;
  let month;
  let year;
  let payrollPeriod;
  let payslipHolder;
  let currentTypeId;
  let payheadPosition;
  document.getElementById('payhead-form').addEventListener('submit',addPayHead);
  document.getElementById('clear-template-btn').addEventListener('click',clearTemplate);
  document.getElementById('nssf-form').addEventListener('submit',addNSSF);
  document.getElementById('nhif-form').addEventListener('submit',addNHIF);
  document.getElementById('edit-payhead-btn').addEventListener('click',function(){submitEditPayhead(currentTypeId,payheadPosition)});
  $(".period-date").datepicker( {
    format: "mm-yyyy",
    viewMode: "months",
    minViewMode: "months",
    autoclose: true
  });

  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  function refreshPage(){
    location.reload();
  }

  function edit(employeeId){

  }

  function addPayHead(e){
    e.preventDefault();
    const name = document.getElementById('payhead-name').value;
    const amount = document.getElementById('payhead-amount').value;
    const type = document.getElementById('payhead-type').value;
    let list;
    const item = document.createElement('li');
    item.className="payhead-item";
    item.innerHTML =`<div class="payhead-btn-group">
						  <button class="btn btn-primary" onclick="displayEditPayheadModal(this)" style="padding:7px; color:#fff;"><i class="material-icons">edit</i></button>
				          <button class="btn btn-danger" onclick="deletePayhead(this)" style="padding:7px;color:#fff;" ><i class="material-icons">delete</i></button>
		  				   </div>
		  				   <div class="payhead-name">${name}</div>
		  				   <div class="payhead-amount">${amount}</div>`;
    if(type.toLowerCase() === 'deduction' ){
      list = document.getElementById('deductions-list');
      list.appendChild(item);
      document.getElementById('payhead-form').reset();
      const total = document.getElementById('deductions-total');
      const newTotal =  Number(total.innerText) +Number(amount);
      total.innerText = newTotal;
      $('#add-payhead-modal').modal('hide');
    }
    else if(type.toLowerCase() === 'earning' ){
      list = document.getElementById('earnings-list');
      list.appendChild(item);
      const total = document.getElementById('earnings-total');
      const newTotal =  Number(total.innerText) +Number(amount);
      total.innerText = newTotal;
      document.getElementById('payhead-form').reset();
      $('#add-payhead-modal').modal('hide');
    }
    else{
      swal({
        title: "Choose Payhead Type",
        buttonsStyling: false,
        confirmButtonClass: "btn btn-success"
      }).catch(swal.noop)
    }
    $('.selectpicker').selectpicker('refresh');
  }

  function addNHIF(e){
    e.preventDefault();
    document.getElementById('template-nhif').innerHTML = document.getElementById('nhif-input').value;
    $('#add-nhif-modal').modal('hide');
  }

  function addNSSF(e){
    e.preventDefault();
    document.getElementById('template-nssf').innerHTML = document.getElementById('nssf-input').value;
    $('#add-nssf-modal').modal('hide');
  }

  function deleteTR(element){
    element.parentNode.parentNode.remove();
  }

  function editPayslip(id){
    payslipHolder = id;
    for(let payslip of payroll.payslips){
      if(payslip.id === id){
        console.log(payslip);
        for(let payhead of payslip.earnings){
          const name = payhead.name;
          const amount = payhead.amount;
          const type= payhead.type;
          let list;
          const item = document.createElement('li');
          item.className="payhead-item";
          item.innerHTML =`<div class="payhead-btn-group">
						  <button class="btn btn-primary" onclick="displayEditPayheadModal(this)" style="padding:7px; color:#fff;"><i class="material-icons">edit</i></button>
				          <button class="btn btn-danger" onclick="deletePayhead(this)" style="padding:7px;color:#fff;" ><i class="material-icons">delete</i></button>
		  				   </div>
		  				   <div class="payhead-name">${name}</div>
		  				   <div class="payhead-amount">${amount}</div>`;
          list = document.getElementById('earnings-list');
          list.appendChild(item);
          const total = document.getElementById('earnings-total');
          const newTotal =  Number(total.innerText) +Number(amount);
          total.innerText = newTotal;
        }
        for(let payhead of payslip.deductions){
          const name = payhead.name;
          const amount = payhead.amount;
          const type= payhead.type;
          let list;
          const item = document.createElement('li');
          item.className="payhead-item";
          item.innerHTML =`<div class="payhead-btn-group">
						  <button class="btn btn-primary" onclick="displayEditPayheadModal(this)" style="padding:7px; color:#fff;"><i class="material-icons">edit</i></button>
				          <button class="btn btn-danger" onclick="deletePayhead(this)" style="padding:7px;color:#fff;" ><i class="material-icons">delete</i></button>
		  				   </div>
		  				   <div class="payhead-name">${name}</div>
		  				   <div class="payhead-amount">${amount}</div>`;
          list = document.getElementById('deductions-list');
          list.appendChild(item);
          document.getElementById('payhead-form').reset();
          const total = document.getElementById('deductions-total');
          const newTotal =  Number(total.innerText) +Number(amount);
          total.innerText = newTotal;

        }
        document.getElementById('template-nssf').innerText = payslip.nssf;
        document.getElementById('template-nhif').innerText = payslip.nhif;
      }
    }
    $('#myModal').modal('show');
  }

  function removeFromPayroll(element,empId){
    swal({
      title: 'Remove Employee  From Payroll',
      text: "You won't be able to revert this!",
      type: 'warning',
      showCancelButton: true,
      confirmButtonClass: 'btn btn-success',
      cancelButtonClass: 'btn btn-danger',
      confirmButtonText: 'Yes, clear it!',
      buttonsStyling: false
    })
       .then(function(){
             fetch("/api/hr/payroll/remove/"+empId)
                    .then(function(res){
                      if(!res.ok){
                        throw Error('Something Went Wrong')
                      }
                      else{
                        const row =  element.parentNode.parentNode;
                        row.remove();
                        employeeTable.draw();
                        swal({
                          title: 'Removed!',
                          text: 'Employee Removed From Payroll',
                          type: 'success',
                          timer: 1500,
                          confirmButtonClass: "btn btn-success",
                          buttonsStyling: false
                        })
                      }
                    })
            }).catch(swal.noop)
  }

  function print(){
    const payslip = document.getElementById('payslip-checkbox');
    const payroll = document.getElementById('payroll-checkbox');
    const period  = document.getElementById('print-period-date');
    let url;
    if(payslip.checked && payroll.checked){
      url = '';
    }
    else if(payslip.checked){
      url = '';
    }
    if(payroll.checked){
      url = '';
    }
    printJS({
      printable:url,
      type:'pdf',
      onError:function(error){
        alert("something Went Wrong!");
      }
    })
  }

  function past() {
    const date = document.getElementById('past-period-date').value;
    window.location = '/hr/payroll/' + date.split('-')[1] + '/' + date.split('-')[0];
  }

  function calculate(){
    const period = document.getElementById('calculate-period-date').value;
    const date =  period.split("-");
    const formData = new FormData();
    month=date[0];
    year = date[1];
    formData.append("month",month);
    formData.append("year",year);
    document.getElementById('content').style.marginTop="20px";
    fetch('/api/hr/payroll/calculate',{
      method:'POST',
      body:formData
    })
    .then(function(res){
      if(res.status == 208){
        errorNotify("Payroll Month Already Generated!");
        $('#calculate-payroll-modal').modal('hide');
        throw Error(res.statusText);
      }
      else if(!res.ok || !res.status == 208){
        errorNotify("Something Went Wrong!");
        $('#calculate-payroll-modal').modal('hide');
        throw Error(res.statusText);
      }
      return res.json();
    })
    .then(function(pr){
      $('#calculate-payroll-modal').modal('hide');
       const periodDisplay = months[Number(period.split("-")[0])-1] + ", " +period.split("-")[1];
      document.getElementById('payroll-nav').classList.remove("nav-active");
      document.getElementById('preview-nav').classList=("nav-active");
       document.getElementById('generate-period').innerHTML=`${period}`;
       payroll = pr;
       console.log(payroll);
       payroll.dateString = period;
       document.getElementById('search-form').style.display= "none";
       document.getElementById('page-heading').innerHtml = `Preview`;
      const payslipsView = document.createElement('ul');
      payslipsView.style.padding="0px";
      payslipsView.style.margin = "0px";
      payslipsView.id = "payslips-view";
      const content =  document.getElementById('content');
      document.getElementById('content-wrapper').style.marginTop="8px";
      content.innerHTML = `<div class="row">
             <div class="col-md-12" style="display:flex;justify-content: space-between">
                <h3>Payroll Preview</h3>
                <button class="btn btn-primary" style="color:#fff" onclick="generate()">Generate Payroll</button>
            </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card card-stats">
                        <div class="card-header" data-background-color="rose" onclick="logPayroll()">
                            <i class="material-icons">equalizer</i>
                        </div>
                        <div class="card-content">
                            <p class="category">Total Salary</p>
                            <h3 class="card-title">${payroll.totalString}</h3>
                        </div>
                        <div class="card-footer">
                            <div class="stats">
                                <i class="material-icons">local_offer</i> sum of all salaries
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card card-stats">
                        <div class="card-header" data-background-color="orange">
                            <i class="material-icons">attach_money</i>
                        </div>
                        <div class="card-content">
                            <p class="category">Tax</p>
                            <h3 class="card-title">${payroll.tax}</h3>
                        </div>
                        <div class="card-footer">
                            <div class="stats">
                                <i class="material-icons">date_range</i> sum of PAYE
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card card-stats">
                        <div class="card-header" data-background-color="blue">
                            <i class="material-icons">payments</i>
                        </div>
                        <div class="card-content">
                            <p class="category">NSSF</p>
                            <h3 class="card-title">${payroll.nssf}</h3>
                        </div>
                        <div class="card-footer">
                            <div class="stats">
                                <i class="material-icons">insert_link</i>Sum of employees nssf contribution
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card card-stats">
                        <div class="card-header" data-background-color="green">
                            <i class="material-icons">local_hospital</i>
                        </div>
                        <div class="card-content">
                            <p class="category">NHIF</p>
                            <h3 class="card-title">${payroll.nhif}</h3>
                        </div>
                        <div class="card-footer">
                            <div class="stats">
                                <i class="material-icons">tag</i>Sum of employees nhif contribution
                            </div>
                        </div>
                    </div>
                </div>
             </div>`;
      content.appendChild(payslipsView);
      const payslips = payroll.payslips;
      for(let template of payslips){
        let templateDiv =  document.createElement('div');
        templateDiv.id= `ps-id-${template.id}`;
        templateDiv.className='col-md-12';
        payslipsView.appendChild(templateDiv);
        templateDiv.innerHTML = `<div class="card">
                            <div class="card-header">
                               <div class="row">
                                <div class="col-md-2">
                                    <div class="user">
                                      <div class="photo">
                                        <img style="height: 120px;border-radius: 5px" src="/docs-upload/${template.employee.image.name}" />
                                      </div>
                                    </div>
                                    </div>
                                <div class="col-md-8">
                                  <div class="row">
                                          <div class="col-md-6">
                                           <label style="width:150px">name</label> <h4>${template.employee.name}</h4>
                                          </div>
                                          <div class="col-md-6">
                                            <label style="width:150px">Salary</label> <h4>${template.grossSalary}</h4>
                                          </div>
                                           <div class="col-md-6">
                                            <label style="width:150px">NHIF</label> <h4>${template.nhif}</h4>
                                          </div>
                                           <div class="col-md-6">
                                            <label style="width:150px">NSSF</label> <h4>${template.nssf}</h4>
                                          </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="card-content">
                                <div class="col-md-12">
                                    <div>
                                        <div >
                                            <div class="panel-group" id="${template.id}"  role="tablist" aria-expanded="false" aria-multiselectable="true">
                                                <div class="panel">
                                                    <div class="panel-heading" role="tab" id="headingOne">
                                                        <a role="button" data-toggle="collapse" aria-expanded="false" data-parent="#${template.id}" href="#${template.id}-ps"  aria-controls="#${template.id}-ps">
                                                            <h4 class="panel-title">
                                                                PaySlip
                                                                <i class="material-icons">keyboard_arrow_down</i>
                                                            </h4>
                                                        </a>
                                                    </div>
                                                    <div id="${template.id}-ps" class="panel-collapse collapse " role="tabpanel" aria-labelledby="headingOne">
                                                        <div class="panel-body">
                                                            <div>
                                                                <div>
                                                                    <div class="toolbar payslip-btn-group">
                                                                        <div>

                                                                        </div>
                                                                        <div>
                                                                            <button class="btn btn-success btn-fab btn-fab-mini btn-round" onclick="editPayslip(${template.id})"><i class="material-icons">edit</i></button>
                                                                            <button class="btn btn-danger btn-fab btn-fab-mini btn-round" onclick="deletePayslip(${template.id})"><i class="material-icons">delete</i></button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="payslip-container">
                                                                        <div class="payslip-header-container">
                                                                            <div class="element-header">
                                                                                <h4>Earnings</h4>
                                                                            </div>
                                                                            <div class="element-header">
                                                                                <h4>Tax Calculations</h4>
                                                                            </div>
                                                                            <div class="element-header">
                                                                                <h4>Deductions</h4>
                                                                            </div>
                                                                            <div class="element-header">
                                                                                <h4>Net Pay</h4>
                                                                            </div>
                                                                        </div>
                                                                        <div class="element-body-container" id="payslip-${template.id}-content">
                                                                            <div class="element-body">
                                                                                <ul class="units-list" id="${template.id}-earnings">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list" id="${template.id}-tax">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list" id="${template.id}-deductions">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list">
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Gross Salary</div>
                                                                                        <label  class="unit-value">${template.grossSalary}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Net Tax</div>
                                                                                        <label class="unit-value">${template.netTax}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Deductions</div>
                                                                                        <label  class="unit-value">${template.totalDeductions}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label"> Net Salary</div>
                                                                                        <label class="unit-value">${template.netSalary}</label>
                                                                                    </li>
                                                                                </ul>
                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
        let payslipEarnings = document.getElementById(template.id +'-earnings');
        let earningsOutput = "";
        let earnings =  template.earnings;
        for(let earning of earnings){
          let  li = document.createElement('li');
          li.className= "unit";
          li.innerHTML = `<div  class="unit-label">${earning.name}</div>
                           <label class="unit-value">${earning.amount}</label>`;
          payslipEarnings.appendChild(li);
        }
        let  nssfLi = document.createElement('li');
        nssfLi.className= "unit";
        nssfLi.innerHTML = `<div  class="unit-label">NSSF</div>
                                        <label class="unit-value">${template.nssf}</label>`;
        payslipEarnings.appendChild(nssfLi);
        let  grossSalaryLi = document.createElement('li');
        grossSalaryLi.className= "unit";
        grossSalaryLi.innerHTML = `<div  class="unit-label">Gross Salary</div>
                                               <label class="unit-value">${template.grossSalary}</label>`;
        payslipEarnings.appendChild(grossSalaryLi);
        const deductions =document.getElementById(template.id +'-deductions');
        for(let deduction of template.deductions){
          let  li = document.createElement('li');
          li.className= "unit";
          li.innerHTML = `<div  class="unit-label">${deduction.name}</div>
                                        <label class="unit-value">${deduction.amount}</label>`;
          deductions.appendChild(li);
        }
        let  nhifLi = document.createElement('li');
        nhifLi.className= "unit";
        nhifLi.innerHTML = `<div  class="unit-label">NHIF</div>
                            <label class="unit-value">${template.nhif}</label>`;
        deductions.appendChild(nhifLi);
        const taxList = document.getElementById(template.id+'-tax');
        const tax = document.createElement('li');
        tax.className= 'unit';
        tax.innerHTML = `<div class="unit-label"> Tax</div>
                                    <label  class="unit-value">${template.tax}</label>`;
        taxList.appendChild(tax);
        for(let  relief of template.reliefs){
          let li = document.createElement('li');
          li.className= 'unit';
          li.innerHTML = `<div  class="unit-label">${relief.name}</div>
                                        <label  class="unit-value">${relief.rate}</label>`;
          taxList.appendChild(li);
        }
        const netTax = document.createElement('li');
        netTax.className= 'unit';
        netTax.innerHTML = `<div class="unit-label"> Net Tax</div>
                                    <label  class="unit-value">${template.netTax}</label>`;
        taxList.appendChild(netTax);
      }
    });
  }

  function generate(){
      url = `/api/hr/payroll/generate/${year}/${month}`;
      fetch(url,{
        method:'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payroll)
      })
      .then(function(res){
        if(!res.ok){
          errorNotify("Something Went Wrong!");
          throw Error(res.statusText);
        }
        else{
          successNotify("Something Went Wrong!");
          window.location=`/hr/payroll/${year}/${month}`;
        }
      });
  }

  function deletePayhead(element){
    const li = element.parentNode.parentNode;
    const amount  = li.children[2].innerText;
    if(li.parentNode.id ==="deductions-list"){
      document.getElementById('deductions-total').innerHTML =(Number(document.getElementById('deductions-total').innerText) - Number(amount)).toString();
    }
    else if(li.parentNode.id ==="earnings-list"){
      document.getElementById('earnings-total').innerHTML =(Number(document.getElementById('earnings-total').innerText) - Number(amount)).toString();
    }
    li.remove();
  }

  function displayEditPayheadModal(element){
    const li =element.parentNode.parentNode;
    const name = li.children[1].innerText;
    const amount = li.children[2].innerText;
    currentTypeId = li.parentNode.id;
    payheadPosition = Array.from(li.parentNode.children).indexOf(li);
    document.getElementById('edit-payhead-name').value= name;
    document.getElementById('edit-payhead-amount').value= amount;
    $('#edit-payhead-modal').modal('show');
  }

  function submitEditPayhead(currentType,payheadPosition){
    const payheadType = document.getElementById(currentTypeId);
    const li = payheadType.children[payheadPosition];
    const name = document.getElementById('edit-payhead-name').value;
    const amount = document.getElementById('edit-payhead-amount').value;

    if(currentType == "earnings-list"){
      const total = document.getElementById('earnings-total');
      const newTotal =  Number(total.innerText) + Number(amount) -Number(li.children[2].innerText);
      total.innerHTML = newTotal;
    }
    else if(currentType == "deductions-list"){
      const total = document.getElementById('deductions-total');
      const newTotal =  Number(total.innerText) + Number(amount) -Number(li.children[2].innerText);
      total.innerHTML = newTotal;
    }
    li.children[1].innerText = name;
    li.children[2].innerText = amount;
    $('#edit-payhead-modal').modal('hide');
  }

  function clearTemplate(){
    swal({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      type: 'warning',
      showCancelButton: true,
      confirmButtonClass: 'btn btn-success',
      cancelButtonClass: 'btn btn-danger',
      confirmButtonText: 'Yes, clear it!',
      buttonsStyling: false
    })
            .then(function(){
              document.getElementById('earnings-list').innerHTML ="";
              document.getElementById('deductions-list').innerHTML ="";
              document.getElementById('template-nssf').innerHTML ="0";
              document.getElementById('template-nhif').innerHTML ="0";
              document.getElementById('earnings-total').innerHTML ="0";
              document.getElementById('deductions-total').innerHTML ="0";
              swal({
                title: 'Cleared!',
                text: 'Template Cleared',
                type: 'success',
                timer: 1500,
                confirmButtonClass: "btn btn-success",
                buttonsStyling: false
              })
            }).catch(swal.noop)
  }

  function closeAddPayhead(){
    document.getElementById('payhead-form').reset();
    $('#add-payhead-modal').modal('hide');
  }

  function savePayslip(){
    let template={
      id:payslipHolder,
      earnings:[],
      deductions:[],
      reliefs:[],
      nssf:null,
      nhif:null,
    };
    template.nssf = Number(document.getElementById('template-nssf').innerText);
    template.nhif = Number(document.getElementById('template-nhif').innerText);
    const earningsList = document.getElementById('earnings-list').children;
    const deductionsList = document.getElementById('deductions-list').children;
    for(let i=0;i<earningsList.length;i++){
      let name = earningsList[i].children[1].innerText;
      let amount = earningsList[i].children[2].innerText;
      let payhead = {
        name:name,
        amount:Number(amount),
        type:"earning"
      }
      template.earnings.push(payhead);
    }
    for(let i=0;i<deductionsList.length;i++){
      let name = deductionsList[i].children[1].innerText;
      let amount = deductionsList[i].children[2].innerText;
      let payhead = {
        name:name,
        amount:Number(amount),
        type:"deduction"
      }
      template.deductions.push(payhead);
    }
    fetch("/api/hr/payslip/calulate",{
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(template)
    })
    .then(function(res){
      if(!res.ok){
        errorNotify("Something Went wrong");
        $('#myModal').modal('hide');
        throw new Error(res.statusText);
      }
      return res.json();
    })
    .then(function(payslip){
      console.log(payslip);
      document.getElementById(`payslip-${payslipHolder}-content`).innerHTML=`<div class="element-body">
                                                                                <ul class="units-list" id="${payslip.id}-earnings">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list" id="${payslip.id}-tax">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list" id="${payslip.id}-deductions">

                                                                                </ul>
                                                                            </div>
                                                                            <div class="element-body">
                                                                                <ul class="units-list">
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Gross Salary</div>
                                                                                        <label  class="unit-value">${payslip.grossSalary}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Net Tax</div>
                                                                                        <label class="unit-value">${payslip.netTax}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label" > Deductions</div>
                                                                                        <label  class="unit-value">${payslip.totalDeductions}</label>
                                                                                    </li>
                                                                                    <li class="unit" >
                                                                                        <div class="unit-label"> Net Salary</div>
                                                                                        <label class="unit-value">${payslip.netSalary}</label>
                                                                                    </li>
                                                                                </ul>
                                                                            </div>`;
      let payslipEarnings = document.getElementById(payslip.id +'-earnings');
      let earningsOutput = "";
      let earnings =  payslip.earnings;
      for(let earning of earnings){
        let  li = document.createElement('li');
        li.className= "unit";
        li.innerHTML = `<div  class="unit-label">${earning.name}</div>
                           <label class="unit-value">${earning.amount}</label>`;
        payslipEarnings.appendChild(li);
      }
      let  nssfLi = document.createElement('li');
      nssfLi.className= "unit";
      nssfLi.innerHTML = `<div  class="unit-label">NSSF</div>
                        <label class="unit-value">${payslip.nssf}</label>`;
      payslipEarnings.appendChild(nssfLi);
      let  grossSalaryLi = document.createElement('li');
      grossSalaryLi.className= "unit";
      grossSalaryLi.innerHTML = `<div  class="unit-label">Gross Salary</div>
                              <label class="unit-value">${payslip.grossSalary}</label>`;
      payslipEarnings.appendChild(grossSalaryLi);
      const deductions =document.getElementById(payslip.id +'-deductions');
      for(let deduction of template.deductions){
        let  li = document.createElement('li');
        li.className= "unit";
        li.innerHTML = `<div  class="unit-label">${deduction.name}</div>
                                        <label class="unit-value">${deduction.amount}</label>`;
        deductions.appendChild(li);
      }
      let  nhifLi = document.createElement('li');
      nhifLi.className= "unit";
      nhifLi.innerHTML = `<div  class="unit-label">NHIF</div>
                        <label class="unit-value">${payslip.nhif}</label>`;
      deductions.appendChild(nhifLi);
      const taxList = document.getElementById(payslip.id+'-tax');
      const tax = document.createElement('li');
      tax.className= 'unit';
      tax.innerHTML = `<div class="unit-label"> Tax</div>
                     <label  class="unit-value">${payslip.tax}</label>`;
      taxList.appendChild(tax);
      for(let  relief of payslip.reliefs){
        let li = document.createElement('li');
        li.className= 'unit';
        li.innerHTML = `<div  class="unit-label">${relief.name}</div>
                                        <label  class="unit-value">${relief.rate}</label>`;
        taxList.appendChild(li);
      }
      const netTax = document.createElement('li');
      netTax.className= 'unit';
      netTax.innerHTML = `<div class="unit-label"> Net Tax</div>
                                    <label  class="unit-value">${payslip.netTax}</label>`;
      taxList.appendChild(netTax);
      for(let i=0;i<payroll.payslips.length;i++){
        if(payroll.payslips[i].id === payslip.id){
          payslip.employee = payroll.payslips[i].employee;
          payroll.payslips.splice(i, 1);
          payroll.payslips.push(payslip)
        }
      }
      $('#myModal').modal('hide');
    })

  }

  function logPayroll(){
    console.log(payroll);
  }

  function deletePayslip(id){
    swal({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      type: 'warning',
      showCancelButton: true,
      confirmButtonClass: 'btn btn-success',
      cancelButtonClass: 'btn btn-danger',
      confirmButtonText: 'Yes, clear it!',
      buttonsStyling: false
    })
    .then(function(){
      console.log(id);
      for(let i=0;i<payroll.payslips.length;i++){
          if(payroll.payslips[i].id == id){
            payroll.payslips.splice(i,1);
            document.getElementById(`ps-id-${id}`).remove();
          }
      }
      swal({
        title: 'Cleared!',
        text: 'Template Cleared',
        type: 'success',
        timer: 1500,
        confirmButtonClass: "btn btn-success",
        buttonsStyling: false
      })
    }).catch(swal.noop)
  }

  function editEmployee(id){
    window.location = `/admin/employee/edit/${id}`;
  }

</script>
<script th:src="@{/js/collection.js}"></script>
</html>
